<!DOCTYPE html>
<html lang="pl">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>NodeWatch Dashboard</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
		<style>
			body {
				background-color: #121212;
				color: #fff;
				padding-top: 90px;
				font-family: 'Segoe UI', sans-serif;
			}

			/* padding-top dla sticky navbar */
			.list-group-item {
				background-color: #ffffff;
				border: 1px solid #ddd;
				margin-bottom: 8px;
				border-radius: 0.5rem;
			}

			.list-group-item .health-status {
				font-weight: 600;
				margin-right: 10px;
			}

			.btn-sm {
				font-size: 0.75rem;
			}


			.container-icon {
				font-size: 1.2rem;
				margin-right: 5px;
			}

			.progress-label {
				font-size: 0.85rem;
				margin-bottom: 4px;
			}

			.progress {
				height: 6px;
				margin-top: 4px;
				border-radius: 0.5rem;
			}

			.metric-label {
				font-size: 0.8rem;
				color: #555;
				margin-top: 2px;
				text-align: center;
			}

			.metrics-row {
				display: flex;
				justify-content: space-between;
				gap: 10px;
				margin-top: 8px;
			}

			.metric {
				flex: 1;
				min-width: 60px;
			}


		</style>
	</head>
	<body class="p-4">


		<!-- === Sticky Navbar === -->
		<nav class="navbar fixed-top custom-navbar">
			<div class="container-fluid d-flex align-items-center justify-content-between">

				<!-- Lewa sekcja -->
				<div class="d-flex align-items-center">
					<i class="bi bi-hdd-network me-2 fs-4 text-primary"></i>
					<span class="fw-semibold text-light fs-5">NodeWatch</span>
					<span id="navbarHost" class="ms-2 text-muted small">ctl01</span>
				</div>

				<!-- Sekcja metryk -->
				<div class="d-flex align-items-center gap-3" id="navbarMetrics">
				<div class="metric">
					<span class="label">CPU</span>
					<div class="bar bg-primary-subtle"><div class="fill bg-primary" style="width:30%"></div></div>
					<span class="value text-primary">30%</span>
				</div>
				<div class="metric">
					<span class="label">RAM</span>
					<div class="bar bg-success-subtle"><div class="fill bg-success" style="width:45%"></div></div>
					<span class="value text-success">45%</span>
				</div>
				<div class="metric">
					<span class="label">DYSK</span>
					<div class="bar bg-info-subtle"><div class="fill bg-info" style="width:60%"></div></div>
					<span class="value text-info">60%</span>
				</div>
				<div class="metric">
					<span class="label">TEMP</span>
					<div class="bar bg-warning-subtle"><div class="fill bg-warning" style="width:50%"></div></div>
					<span class="value text-warning">50°C</span>
				</div>
				</div>

				<!-- Prawa sekcja -->
				<div class="d-flex align-items-center gap-3">
					<i class="bi bi-bell-fill text-light fs-5 icon-hover" title="Alerty" data-bs-toggle="modal" data-bs-target="#modalAlerts"></i>
					<i class="bi bi-gear-fill text-light fs-5 icon-hover" title="Ustawienia" data-bs-toggle="modal" data-bs-target="#modalSettings"></i>
					<i class="bi bi-info-circle-fill text-light fs-5 icon-hover" title="Informacje" data-bs-toggle="modal" data-bs-target="#modalInfo"></i>
				</div>

			</div>
		</nav>

		<style>
		.custom-navbar {
		background: linear-gradient(90deg, #0d0d0f 0%, #111 100%);
		border-bottom: 1px solid #222;
		padding: 0.4rem 1rem;
		box-shadow: 0 1px 10px rgba(0,0,0,0.6);
		z-index: 9999;
		}

		.metric {
		display: flex;
		align-items: center;
		gap: 6px;
		}

		.metric .label {
		font-size: 0.75rem;
		color: #aaa;
		min-width: 35px;
		text-align: right;
		}

		.metric .bar {
		position: relative;
		width: 70px;
		height: 6px;
		border-radius: 4px;
		overflow: hidden;
		background-color: #2a2a2a !important;
		}

		.metric .bar .fill {
		height: 100%;
		transition: width 0.4s ease;
		}

		.metric .value {
		font-size: 0.75rem;
		font-weight: 500;
		min-width: 40px;
		text-align: left;
		}

		.icon-hover {
			cursor: pointer;
			transition: color 0.2s ease, transform 0.2s ease;
		}

		.icon-hover:hover {
			color: #0d6efd;
			transform: scale(1.15);
		}

		.modal-content {
			box-shadow: 0 0 30px rgba(0,0,0,0.8);
		}

		.form-control:focus, .form-select:focus {
			border-color: #0d6efd;
			box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
		}
		</style>


		<!-- === Główna zawartość === -->
		<div class="container mt-5">
			<ul class="list-group" id="serversList"></ul>
		</div>


		<!-- Host Info Modal -->
		<div class="modal fade" id="serverInfoModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">
							<i class="bi bi-info-circle"></i> Informacje o serwerze
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body" id="serverInfoBody"></div>
				</div>
			</div>
		</div>

		<!-- Containers Modal -->
		<div class="modal fade" id="containersModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">
							<i class="bi bi-box-seam"></i> Kontenery
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<ul class="list-group" id="containersList"></ul>
					</div>
				</div>
			</div>
		</div>


		<!-- Toast container -->
		<div class="position-fixed top-1 end-0 p-3" style="z-index: 5080;">
			<div id="alertsContainer"></div>
		</div>

		<!-- Modal: Alerty -->
		<div class="modal fade" id="modalAlerts" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content bg-dark text-light border-secondary">
				<div class="modal-header border-secondary">
					<h5 class="modal-title"><i class="bi bi-bell-fill me-2 text-warning"></i>Alerty systemowe</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">

					<div class="d-flex justify-content-end mb-3">
						<button class="btn btn-sm btn-danger" onclick="clearAlerts()">
						<i class="bi bi-trash"></i> Wyczyść alerty </button>
					</div>

					
					<div id="alertsList" class="list-group list-group-flush">
						<p class="text-muted mb-0" id="noAlerts">Brak aktywnych alertów.</p>
					</div>
				</div>
				</div>
			</div>
		</div>

		<!-- Modal: Ustawienia -->
		<div class="modal fade" id="modalSettings" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content bg-dark text-light border-secondary">
			<div class="modal-header border-secondary">
				<h5 class="modal-title"><i class="bi bi-gear-fill me-2 text-info"></i>Ustawienia systemu</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<form class="row g-3">
				<div class="col-md-6">
					<label class="form-label">Interwał odświeżania (sekundy)</label>
					<input type="number" class="form-control bg-secondary text-light border-0" value="2">
				</div>
				<div class="col-md-6">
					<label class="form-label">Motyw</label>
					<select class="form-select bg-secondary text-light border-0">
					<option>Dark</option>
					<option>Light</option>
					</select>
				</div>
				</form>
			</div>
			<div class="modal-footer border-secondary">
				<button class="btn btn-outline-light" data-bs-dismiss="modal">Anuluj</button>
				<button class="btn btn-primary">Zapisz</button>
			</div>
			</div>
		</div>
		</div>

		<!-- Modal: Informacje -->
		<div class="modal fade" id="modalInfo" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content bg-dark text-light border-secondary">
			<div class="modal-header border-secondary">
				<h5 class="modal-title"><i class="bi bi-info-circle-fill me-2 text-primary"></i>Informacje o systemie</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<p><strong>NodeWatch Agent</strong> — wersja 1.2.4</p>
				<p>Monitorowanie hostów i kontenerów w czasie rzeczywistym.</p>
				<p class="text-muted small mb-0">© 2025 PacynaIT</p>
			</div>
			<div class="modal-footer border-secondary">
				<button class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
			</div>
			</div>
		</div>
		</div>





		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

		<script>
			var socket = io(); // połączenie Socket.IO
		</script>


		<script>
			socket.on('live_host_data', data => {
				document.getElementById('navbarHost').textContent = data.hostname || 'n/a';
				
				const metrics = [
					{ key: 'cpu_percent', color: 'primary', label: 'CPU', suffix: '%' },
					{ key: 'memory_percent', color: 'success', label: 'RAM', suffix: '%' },
					{ key: 'disk_percent', color: 'info', label: 'DYSK', suffix: '%' },
					{ key: 'cpu_temp', color: 'warning', label: 'TEMP', suffix: '°C' }
				];

				const container = document.getElementById('navbarMetrics');
				container.innerHTML = metrics.map(m => {
					const val = data[m.key] ?? 0;
					const width = Math.min(val, 100);
					return `
					<div class="metric">
						<span class="label">${m.label}</span>
						<div class="bar bg-${m.color}-subtle">
						<div class="fill bg-${m.color}" style="width:${width}%"></div>
						</div>
						<span class="value text-${m.color}">${val}${m.suffix}</span>
					</div>
					`;
				}).join('');
			});
		</script>


		<script>
			socket.on("new_alert", function(alert) {

				// === Toast ===
				const container = document.getElementById("alertsContainer");
				const toast = document.createElement("div");
				toast.className = `toast align-items-center text-bg-${alert.level} border-0 m-2`;
				toast.setAttribute("role", "alert");
				toast.setAttribute("aria-live", "assertive");
				toast.setAttribute("aria-atomic", "true");
				toast.innerHTML = `
					<div class="d-flex">
						<div class="toast-body">
							<strong>${alert.hostname}</strong>: ${alert.message}
						</div>
						<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
					</div>`;
				container.appendChild(toast);
				new bootstrap.Toast(toast, { delay: 8000 }).show();

				// === Modal lista alertów ===
				const alertsList = document.getElementById("alertsList");
				const noAlerts = document.getElementById("noAlerts");
				if (noAlerts) noAlerts.remove();

				const alertItem = document.createElement("div");

				// Dobierz kolory tła i tekstu w zależności od poziomu alertu
				let bgClass = "";
				let textClass = "text-light";

				switch (alert.level) {
					case "info":
						bgClass = "bg-primary text-light";
						break;
					case "warning":
						bgClass = "bg-warning text-dark";
						break;
					case "error":
					case "danger":
						bgClass = "bg-danger text-light";
						break;
					case "success":
						bgClass = "bg-success text-light";
						break;
					default:
						bgClass = "bg-secondary text-light";
						break;
				}

				// Utwórz element listy z dynamicznymi kolorami
				alertItem.className = `list-group-item ${bgClass} border-0 rounded-2 shadow-sm mb-2`;
				alertItem.innerHTML = `
					<div class="d-flex justify-content-between align-items-center">
						<span><strong>${alert.hostname}</strong>: ${alert.message}</span>
						<small class="opacity-75">${alert.created_at}</small>
					</div>
				`;
				
				alertsList.prepend(alertItem); // najnowszy alert na górze
			});


			// Czyszczenie alertów
			async function clearAlerts() {
				if (!confirm("Czy na pewno chcesz wyczyścić wszystkie alerty?")) return;
				const res = await fetch('/api/clear_alerts', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-API-KEY': 'TwojSekretnyKlucz'
					},
					body: JSON.stringify({}) // brak hostname = globalnie
				});
				const data = await res.json();
				if (res.ok) {
					alert(data.message || 'Alerty zostały wyczyszczone.');
					// Usuń wszystkie toast'y z DOM
					document.getElementById('alertsContainer').innerHTML = '';
					socket.emit('get_fullstatus'); // odśwież status węzłów
				} else {
					alert(`Błąd: ${data.error || 'Nie udało się wyczyścić alertów.'}`);
				}
			}
		</script>

    
		<script>
			// Ikony typów kontenerów
			function getContainerIcon(container) {
				const name = container.name.toLowerCase();
				// Serwery WWW i proxy
				if (name.includes('nginx')) return 'bi-cloud-lightning';
				if (name.includes('apache')) return 'bi-globe';
				if (name.includes('caddy')) return 'bi-lightning-charge';
				if (name.includes('traefik')) return 'bi-diagram-3';
				// Bazy danych
				if (name.includes('mysql') || name.includes('mariadb')) return 'bi-database';
				if (name.includes('postgres') || name.includes('postgis')) return 'bi-database-check';
				if (name.includes('mongo')) return 'bi-database-fill';
				if (name.includes('redis')) return 'bi-memory';
				if (name.includes('influx')) return 'bi-activity';
				if (name.includes('prometheus')) return 'bi-bar-chart';
				// Aplikacje backendowe
				if (name.includes('node')) return 'bi-node-plus';
				if (name.includes('python') || name.includes('flask') || name.includes('django')) return 'bi-file-code';
				if (name.includes('php') || name.includes('laravel')) return 'bi-filetype-php';
				if (name.includes('java') || name.includes('spring')) return 'bi-cup-hot';
				if (name.includes('go') || name.includes('golang')) return 'bi-lightning';
				if (name.includes('dotnet') || name.includes('aspnet')) return 'bi-microsoft';
				// Monitoring / DevOps
				if (name.includes('grafana')) return 'bi-graph-up';
				if (name.includes('loki')) return 'bi-compass';
				if (name.includes('promtail')) return 'bi-file-earmark-text';
				if (name.includes('elastic') || name.includes('elasticsearch')) return 'bi-search';
				if (name.includes('kibana')) return 'bi-bar-chart-line';
				if (name.includes('portainer')) return 'bi-boxes';
				if (name.includes('watchtower')) return 'bi-eye';
				if (name.includes('cadvisor')) return 'bi-speedometer2';
				// Kolejki i integracje
				if (name.includes('rabbit') || name.includes('mq')) return 'bi-broadcast';
				if (name.includes('kafka')) return 'bi-diagram-3';
				if (name.includes('nats')) return 'bi-send';
				if (name.includes('mqtt')) return 'bi-wifi';
				// Systemy plików, chmura, synchronizacja
				if (name.includes('minio')) return 'bi-cloud-arrow-down';
				if (name.includes('nextcloud') || name.includes('owncloud')) return 'bi-cloud';
				if (name.includes('syncthing')) return 'bi-arrow-repeat';
				if (name.includes('samba') || name.includes('smb')) return 'bi-folder-symlink';
				// Smart Home i multimedia
				if (name.includes('homeassistant')) return 'bi-house';
				if (name.includes('plex')) return 'bi-play-circle';
				if (name.includes('emby')) return 'bi-film';
				if (name.includes('jellyfin')) return 'bi-tv';
				if (name.includes('sonarr') || name.includes('radarr') || name.includes('lidarr') || name.includes('prowlarr')) return 'bi-collection-play';
				if (name.includes('transmission') || name.includes('qbittorrent') || name.includes('torrent')) return 'bi-cloud-download';
				if (name.includes('minecraft') || name.includes('valheim') || name.includes('csgo') || name.includes('factorio')) return 'bi-controller';
				// Narzędzia developerskie
				if (name.includes('gitlab')) return 'bi-git';
				if (name.includes('gitea')) return 'bi-github';
				if (name.includes('jenkins')) return 'bi-gear';
				if (name.includes('vscode') || name.includes('code-server')) return 'bi-terminal';
				if (name.includes('npm')) return 'bi-box2';
				if (name.includes('pnpm')) return 'bi-box2-heart';
				if (name.includes('yarn')) return 'bi-box2-fill';
				// Reverse proxy, sieci, bezpieczeństwo
				if (name.includes('vpn') || name.includes('wireguard') || name.includes('openvpn')) return 'bi-shield-lock';
				if (name.includes('firewall')) return 'bi-shield';
				if (name.includes('proxy')) return 'bi-shuffle';
				if (name.includes('dns') || name.includes('pihole') || name.includes('unbound')) return 'bi-globe2';
				if (name.includes('ngrok')) return 'bi-tornado';
				// Zarządzanie systemem i narzędzia
				if (name.includes('uptime') || name.includes('status')) return 'bi-heart-pulse';
				if (name.includes('dash') || name.includes('dashboard')) return 'bi-speedometer';
				if (name.includes('syslog') || name.includes('rsyslog')) return 'bi-journal-text';
				if (name.includes('cron') || name.includes('scheduler')) return 'bi-clock-history';
				if (name.includes('backup') || name.includes('duplicati') || name.includes('restic')) return 'bi-cloud-upload';
				if (name.includes('fail2ban')) return 'bi-exclamation-octagon';
				if (name.includes('clamav') || name.includes('antivirus')) return 'bi-bug';
				// Kontenery ogólne
				return 'bi-box-seam';
			}
			
			// Renderowanie listy serwerów
			function renderServers(data) {
				const list = document.getElementById('serversList');
				list.innerHTML = '';

				// Wrapper dla siatki kafli
				const grid = document.createElement('div');
				grid.className = 'row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3';

				data.forEach(node => {
					const ip = node.host_info?.ip || 'N/A';

					const failedContainers = node.services.filter(s => s.status !== 'running').length;
					const healthText = failedContainers === 0 ? 'OK' : `Problemy: ${failedContainers}`;
					const healthClass = failedContainers === 0 ? 'text-success' : 'text-danger';

					const typeIcon = node.type === 'VM' ? 'bi-cpu' : node.type === 'Docker Host' ? 'bi-hdd-stack' : 'bi-server';
					const typeBadge = (() => {
						switch (node.type) {
							case 'VM':
								return `<span class="badge bg-primary text-light ms-1">VM</span>`;
							case 'Docker Host':
								return `<span class="badge bg-info text-dark ms-1">Docker</span>`;
							case 'Bare Metal':
								return `<span class="badge bg-secondary text-light ms-1">Bare Metal</span>`;
							case 'LXC':
								return `<span class="badge bg-warning text-dark ms-1">LXC</span>`;
							default:
								return `<span class="badge bg-dark text-light ms-1">${node.type || 'Nieznany'}</span>`;
						}
					})();

					// === Badge host_type ===
					const hostTypeBadge = (() => {
						switch (node.host_type) {
							case 'NAS':
								return `<span class="badge bg-info text-dark">NAS</span>`;
							case 'NAS_MEDIA_GAMES':
								return `<span class="badge bg-primary text-light">NAS + Media + Gry</span>`;
							case 'GAMES':
								return `<span class="badge bg-warning text-dark">Serwer Gier</span>`;
							case 'MEDIA':
								return `<span class="badge bg-success text-light">Serwer Mediów</span>`;
							case 'BACKUP':
								return `<span class="badge bg-secondary text-light">Backup</span>`;
							case 'ALL_IN_ONE':
								return `<span class="badge bg-danger text-light">Usługi / All-in-One</span>`;
							case 'TEST':
								return `<span class="badge bg-light text-dark">Testowy</span>`;
							case 'DEV':
								return `<span class="badge bg-primary-subtle text-dark">Dev</span>`;
							case 'PROXY':
								return `<span class="badge bg-warning-subtle text-dark">Proxy</span>`;
							case 'MONITOR':
								return `<span class="badge bg-success-subtle text-dark">Monitor</span>`;
							default:
								return `<span class="badge bg-secondary-subtle text-dark">${node.host_type || 'Nieznany'}</span>`;
						}
					})();


					const statusBorderClass = node.status === 'online' ? 'border-success' : 'border-danger';
					const statusClass = node.status === 'online' ? 'text-success' : 'text-danger';

					const info = node.host_info || {};

					const cpu = renderProgressBar('CPU', info.cpu_percent, 'primary', '%');
					const ram = renderProgressBar('RAM', info.memory_percent, 'success', '%');
					const temp = renderProgressBar('Temp', info.cpu_temp, 'warning', '°C');
					const disk = renderProgressBar('Dysk', info.disk_percent, 'info', '%');

					const col = document.createElement('div');
					col.className = 'col';

					col.innerHTML = `
						<div class="card text-light bg-dark h-100 shadow-sm ${statusBorderClass}">

							<div class="card-header d-flex justify-content-between align-items-center">
								<div>
									<i class="bi ${typeIcon} fs-4 me-2"></i>
									<strong>${node.agent_hostname}</strong> | ${node.hostname} ${typeBadge}
								</div>
								<div class="${statusClass} fw-semibold">${node.status.toUpperCase()}</div>
							</div>

							<div class="card-header d-flex justify-content-between align-items-center">
								<div>
									<div class="ms-1 text-secondary small">IP: ${ip}</div>
								</div>
								<div class="text-secondary small">
									${node.agent_version}
								</div>
							</div>

							<div class="card-body">
								
								<div class="mb-2 health-status ${healthClass}">${healthText}</div>
								<div class="metrics-row mb-3">
									${cpu}
									${ram}
									${temp}
									${disk}
								</div>
								<div class="d-flex w-100">
									<button class="btn btn-sm btn-secondary flex-fill rounded-2 m-2 p-2" 
										onclick='showServerInfoModal(${JSON.stringify(node).replace(/"/g, '&quot;')})'>
										<i class="bi bi-info-circle"></i> Host
									</button>

									<button class="btn btn-sm btn-info flex-fill rounded-2 m-2 p-2" 
										onclick='showContainersModal(${JSON.stringify(node.services).replace(/"/g, '&quot;')}, "${node.hostname}", "${ip}")'>
										<i class="bi bi-list"></i> Kontenery
									</button>

									<button class="btn btn-sm btn-danger flex-fill rounded-2 m-2 p-2" 
										onclick="deleteNode('${node.hostname}')">
										<i class="bi bi-trash"></i> Usuń
									</button>
								</div>

							</div>
							<div class="card-footer d-flex justify-content-between align-items-center text-secondary small">
								<div>${hostTypeBadge}</div>
								<div class="text-secondary">Raport: ${node.last_seen || 'N/A'}</div>
							</div>

						</div>
					`;

					grid.appendChild(col);
				});

				list.appendChild(grid);
			}

			
			
			// Funkcja renderująca paski obciążenia
			function renderProgressBar(label, value, colorClass, unit) {
				if (value == null) return '';
				const safeValue = Math.min(Math.max(value, 0), 100);
				return `
					<div>
						<div class="metric-label">${label}: ${safeValue}${unit}</div>
						<div class="progress">
							<div class="progress-bar bg-${colorClass}" role="progressbar" style="width: ${safeValue}%"></div>
						</div>
					</div>
  					`;
			}

			// Modal — info o hoście z paskami obciążenia
			function showServerInfoModal(node) {
				const info = node.host_info || {};
				const cpu = info.cpu_percent ?? 0;
				const mem = info.memory_percent ?? 0;
				const disk = info.disk_percent ?? 0;
				const temp = info.cpu_temp ?? 0;
				const body = document.getElementById('serverInfoBody');
				body.innerHTML = `
    
							<p>
								<strong>Hostname:</strong> ${node.hostname}
							</p>
							<p>
								<strong>IP:</strong> ${info.ip || 'n/a'}
							</p>
							<p>
								<strong>Typ:</strong> ${node.type}
							</p>
							<p>
								<strong>Status:</strong> ${node.status}
							</p>
							<p>
								<strong>Docker:</strong> ${info.docker_version || 'n/a'}
							</p>
							<div class="mt-3">
								<div class="progress-label">
									<i class="bi bi-cpu"></i> CPU (${cpu}%)
								</div>
								<div class="progress mb-2">
									<div class="progress-bar bg-danger" style="width: ${cpu}%"></div>
								</div>
								<div class="progress-label">
									<i class="bi bi-memory"></i> RAM (${mem}%)
								</div>
								<div class="progress mb-2">
									<div class="progress-bar bg-warning" style="width: ${mem}%"></div>
								</div>
								<div class="progress-label">
									<i class="bi bi-device-hdd"></i> Dysk (${disk}%)
								</div>
								<div class="progress mb-2">
									<div class="progress-bar bg-info" style="width: ${disk}%"></div>
								</div>
								<div class="progress-label">
									<i class="bi bi-thermometer-half"></i> Temperatura CPU (${temp}°C)
								</div>
								<div class="progress mb-3">
									<div class="progress-bar ${temp < 60 ? 'bg-success' : temp < 80 ? 'bg-warning' : 'bg-danger'}" style="width: ${Math.min(temp,100)}%">
									</div>
								</div>
							</div>
							<p>
								<strong>Uptime:</strong> ${info.uptime ? (info.uptime / 3600).toFixed(1) + ' h' : 'n/a'}
							</p>
  `;
				new bootstrap.Modal(document.getElementById('serverInfoModal')).show();
			}
			// Modal — lista kontenerów
			let currentHost = ''; // globalna zmienna do użycia w docker compose
			function showContainersModal(services, hostname, ip) {
				currentHost = hostname; // ustawiamy aktualny host
				const list = document.getElementById('containersList');
				list.innerHTML = '';
				if (services.length === 0) {
					list.innerHTML = ' < li class = "list-group-item" > Brak kontenerów < /li>';
					return;
				}
				services.forEach(s => {
					const icon = getContainerIcon(s);
					const li = document.createElement('li');
					li.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap';
					let linkBtn = '';
					if (s.port && ip) {
						const match = s.port.match(/(\d+)->/);
						if (match) {
							linkBtn = `
							<a href="http://${ip}:${match[1]}" target="_blank" class="btn btn-sm btn-outline-primary me-1 mb-1">
								<i class="bi bi-box-arrow-up-right"></i>
							</a>`;
						}
					}
					li.innerHTML = `
      
							<div class="d-flex align-items-center gap-2 flex-wrap">
								<i class="bi ${icon} container-icon"></i> ${s.name} ${s.port ? `
								<span class="badge bg-info">${s.port}</span>` : ''}
      
							</div>
							<div class="d-flex align-items-center gap-1 flex-wrap">
								<span class="badge ${s.status === 'running' ? 'bg-success' : 'bg-danger'}">${s.status}</span>
        ${linkBtn}
        
								<button class="btn btn-sm btn-success" onclick="containerAction('${ip}','${s.name}', 'start')">
									<i class="bi bi-play-fill"></i>
								</button>
								<button class="btn btn-sm btn-warning" onclick="containerAction('${ip}','${s.name}', 'stop')">
									<i class="bi bi-arrow-clockwise"></i>
								</button>
								<button class="btn btn-sm btn-danger" onclick="containerAction('${ip}','${s.name}', 'restart')">
									<i class="bi bi-stop-fill"></i>
								</button>
							</div>
    `;
					list.appendChild(li);
				});
				new bootstrap.Modal(document.getElementById('containersModal')).show();
			}
			// Operacje na kontenerach – START / STOP / RESTART
			async function containerAction(hostname, container_name, action) {
				if (!confirm(`Czy na pewno chcesz ${action} kontener ${container_name} na serwerze ${hostname}?`)) return;
				const res = await fetch('/api/container_action', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						hostname,
						container_name,
						action
					})
				});
				const data = await res.json();
				alert(data.message || data.error);
				socket.emit('get_fullstatus');
			}
			// Wykonanie Docker Compose – osobny endpoint
			async function executeDockerCompose(hostname) {
				const composeContent = document.getElementById('dockerComposeTextarea').value.trim();
				if (!composeContent) return alert("Wklej zawartość docker-compose.yml");
				if (!confirm(`Czy na pewno chcesz wykonać Docker Compose na serwerze ${hostname}?`)) return;
				const res = await fetch('/api/compose_execute', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						hostname,
						compose: composeContent
					})
				});
				const data = await res.json();
				alert(data.message || data.error);
				socket.emit('get_fullstatus');
			}
			// Socket.IO eventy
			socket.on('connect', () => socket.emit('get_fullstatus'));
			socket.on('fullstatus', data => renderServers(data));
			socket.on('update_nodes', () => socket.emit('get_fullstatus'));
			socket.on('live_host_data', data => {
				console.log('Host live data:', data);
			});
			// Usuwanie serwera
			async function deleteNode(hostname) {
				if (!confirm(`Czy na pewno chcesz usunąć serwer "${hostname}"?`)) return;
				const res = await fetch(`/api/delete_node`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"X-API-KEY": "TwojSekretnyKlucz"
					},
					body: JSON.stringify({
						hostname
					})
				});
				const data = await res.json();
				if (res.ok) {
					alert(data.message || `Serwer ${hostname} usunięty.`);
					socket.emit("get_fullstatus");
				} else {
					alert(`Błąd: ${data.error || "Nie udało się usunąć serwera."}`);
				}
			}
		</script>
	</body>
</html>