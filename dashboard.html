<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Central Dashboard ctl01</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { background-color: #f2f2f2; color: #212529; }
.list-group-item { background-color: #ffffff; border: 1px solid #ddd; margin-bottom: 8px; border-radius: 0.5rem; }
.list-group-item .health-status { font-weight: 600; margin-right: 10px; }
.btn-sm { font-size: 0.75rem; }
.modal-content { background-color: #ffffff; color: #212529; }
.modal-header { background-color: #007bff; color: #fff; font-weight: 600; }
.container-icon { font-size: 1.2rem; margin-right: 5px; }
.progress { height: 0.8rem; border-radius: 0.5rem; }
.progress-label { font-size: 0.85rem; margin-bottom: 4px; }
.progress { height: 6px; margin-top: 4px; }
.metric-label { font-size: 0.8rem; color: #555; margin-top: 2px; text-align: center; }
.metrics-row { display: flex; justify-content: space-between; gap: 10px; margin-top: 8px; }
.metric { flex: 1; min-width: 60px; }
</style>
</head>
<body class="p-4">

<div class="container">
  <h2 class="mb-4"><i class="bi bi-hdd-network"></i> Central Dashboard (ctl01)</h2>
  <ul class="list-group" id="serversList"></ul>
</div>

<!-- Host Info Modal -->
<div class="modal fade" id="serverInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-info-circle"></i> Informacje o serwerze</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="serverInfoBody"></div>
    </div>
  </div>
</div>

<!-- Containers Modal -->
<div class="modal fade" id="containersModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-box-seam"></i> Kontenery</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group" id="containersList"></ul>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<!-- Toast container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div id="alertsContainer"></div>
</div>

<div class="d-flex justify-content-end mb-3">
  <button class="btn btn-sm btn-outline-danger" onclick="clearAlerts()">
    <i class="bi bi-trash"></i> Wyczyść alerty
  </button>
</div>

<script>
var socket = io(); // połączenie Socket.IO

socket.on("new_alert", function(alert) {
    const container = document.getElementById("alertsContainer");
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${alert.level} border-0`;
    toast.setAttribute("role", "alert");
    toast.setAttribute("aria-live", "assertive");
    toast.setAttribute("aria-atomic", "true");
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${alert.message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
    container.appendChild(toast);
    var bsToast = new bootstrap.Toast(toast, {delay: 8000});
    bsToast.show();
});

// Czyszczenie alertów
async function clearAlerts(){
  if(!confirm("Czy na pewno chcesz wyczyścić wszystkie alerty?")) return;

  const res = await fetch('/api/clear_alerts', {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'X-API-KEY': 'TwojSekretnyKlucz'},
    body: JSON.stringify({})  // brak hostname = globalnie
  });
  const data = await res.json();
  if(res.ok){
    alert(data.message || 'Alerty zostały wyczyszczone.');
    // Usuń wszystkie toast'y z DOM
    document.getElementById('alertsContainer').innerHTML = '';
    socket.emit('get_fullstatus'); // odśwież status węzłów
  } else {
    alert(`Błąd: ${data.error || 'Nie udało się wyczyścić alertów.'}`);
  }
}

// Jeśli chcesz, możesz też czyścić alerty tylko dla jednego hosta
async function clearHostAlerts(hostname){
  if(!confirm(`Czy na pewno chcesz wyczyścić alerty dla serwera ${hostname}?`)) return;

  const res = await fetch('/api/clear_alerts', {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'X-API-KEY': 'TwojSekretnyKlucz'},
    body: JSON.stringify({hostname})
  });
  const data = await res.json();
  if(res.ok){
    alert(data.message || `Alerty dla ${hostname} zostały wyczyszczone.`);
    socket.emit('get_fullstatus');
  } else {
    alert(`Błąd: ${data.error || 'Nie udało się wyczyścić alertów.'}`);
  }
}
</script>


<script>
//const socket = io();

// Ikony typów kontenerów
function getContainerIcon(container) {
  const name = container.name.toLowerCase();

  // Serwery WWW i proxy
  if (name.includes('nginx')) return 'bi-cloud-lightning';
  if (name.includes('apache')) return 'bi-globe';
  if (name.includes('caddy')) return 'bi-lightning-charge';
  if (name.includes('traefik')) return 'bi-diagram-3';

  // Bazy danych
  if (name.includes('mysql') || name.includes('mariadb')) return 'bi-database';
  if (name.includes('postgres') || name.includes('postgis')) return 'bi-database-check';
  if (name.includes('mongo')) return 'bi-database-fill';
  if (name.includes('redis')) return 'bi-memory';
  if (name.includes('influx')) return 'bi-activity';
  if (name.includes('prometheus')) return 'bi-bar-chart';

  // Aplikacje backendowe
  if (name.includes('node')) return 'bi-node-plus';
  if (name.includes('python') || name.includes('flask') || name.includes('django')) return 'bi-file-code';
  if (name.includes('php') || name.includes('laravel')) return 'bi-filetype-php';
  if (name.includes('java') || name.includes('spring')) return 'bi-cup-hot';
  if (name.includes('go') || name.includes('golang')) return 'bi-lightning';
  if (name.includes('dotnet') || name.includes('aspnet')) return 'bi-microsoft';

  // Monitoring / DevOps
  if (name.includes('grafana')) return 'bi-graph-up';
  if (name.includes('loki')) return 'bi-compass';
  if (name.includes('promtail')) return 'bi-file-earmark-text';
  if (name.includes('elastic') || name.includes('elasticsearch')) return 'bi-search';
  if (name.includes('kibana')) return 'bi-bar-chart-line';
  if (name.includes('portainer')) return 'bi-boxes';
  if (name.includes('watchtower')) return 'bi-eye';
  if (name.includes('cadvisor')) return 'bi-speedometer2';

  // Kolejki i integracje
  if (name.includes('rabbit') || name.includes('mq')) return 'bi-broadcast';
  if (name.includes('kafka')) return 'bi-diagram-3';
  if (name.includes('nats')) return 'bi-send';
  if (name.includes('mqtt')) return 'bi-wifi';

  // Systemy plików, chmura, synchronizacja
  if (name.includes('minio')) return 'bi-cloud-arrow-down';
  if (name.includes('nextcloud') || name.includes('owncloud')) return 'bi-cloud';
  if (name.includes('syncthing')) return 'bi-arrow-repeat';
  if (name.includes('samba') || name.includes('smb')) return 'bi-folder-symlink';

  // Smart Home i multimedia
  if (name.includes('homeassistant')) return 'bi-house';
  if (name.includes('plex')) return 'bi-play-circle';
  if (name.includes('emby')) return 'bi-film';
  if (name.includes('jellyfin')) return 'bi-tv';
  if (name.includes('sonarr') || name.includes('radarr') || name.includes('lidarr') || name.includes('prowlarr')) return 'bi-collection-play';
  if (name.includes('transmission') || name.includes('qbittorrent') || name.includes('torrent')) return 'bi-cloud-download';
  if (name.includes('minecraft') || name.includes('valheim') || name.includes('csgo') || name.includes('factorio')) return 'bi-controller';

  // Narzędzia developerskie
  if (name.includes('gitlab')) return 'bi-git';
  if (name.includes('gitea')) return 'bi-github';
  if (name.includes('jenkins')) return 'bi-gear';
  if (name.includes('vscode') || name.includes('code-server')) return 'bi-terminal';
  if (name.includes('npm')) return 'bi-box2';
  if (name.includes('pnpm')) return 'bi-box2-heart';
  if (name.includes('yarn')) return 'bi-box2-fill';

  // Reverse proxy, sieci, bezpieczeństwo
  if (name.includes('vpn') || name.includes('wireguard') || name.includes('openvpn')) return 'bi-shield-lock';
  if (name.includes('firewall')) return 'bi-shield';
  if (name.includes('proxy')) return 'bi-shuffle';
  if (name.includes('dns') || name.includes('pihole') || name.includes('unbound')) return 'bi-globe2';
  if (name.includes('ngrok')) return 'bi-tornado';

  // Zarządzanie systemem i narzędzia
  if (name.includes('uptime') || name.includes('status')) return 'bi-heart-pulse';
  if (name.includes('dash') || name.includes('dashboard')) return 'bi-speedometer';
  if (name.includes('syslog') || name.includes('rsyslog')) return 'bi-journal-text';
  if (name.includes('cron') || name.includes('scheduler')) return 'bi-clock-history';
  if (name.includes('backup') || name.includes('duplicati') || name.includes('restic')) return 'bi-cloud-upload';
  if (name.includes('fail2ban')) return 'bi-exclamation-octagon';
  if (name.includes('clamav') || name.includes('antivirus')) return 'bi-bug';

  // Kontenery ogólne
  return 'bi-box-seam';
}


// Renderowanie listy serwerów
function renderServers(data){
  const list = document.getElementById('serversList');
  list.innerHTML = '';

  data.forEach(node => {
    const ip = node.host_info?.ip || 'n/a';
    const failedContainers = node.services.filter(s => s.status !== 'running').length;
    const healthText = failedContainers === 0 ? 'OK' : `Problemy: ${failedContainers}`;
    const healthClass = failedContainers === 0 ? 'text-success' : 'text-danger';
    const typeIcon = node.type === 'VM' ? 'bi-cpu' :
                     node.type === 'Docker Host' ? 'bi-hdd-stack' : 'bi-server';
    const statusClass = node.status === 'online' ? 'text-success' : 'text-danger';

    const info = node.host_info || {};
    const cpu = renderProgressBar('CPU', info.cpu_percent, 'primary');
    const ram = renderProgressBar('RAM', info.memory_percent, 'success');
    const temp = renderProgressBar('Temp', info.cpu_temp, 'warning');
    const disk = renderProgressBar('Dysk', info.disk_percent, 'info');

    const li = document.createElement('li');
    li.className = 'list-group-item';

    li.innerHTML = `
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
            <i class="bi ${typeIcon} fs-4 text-secondary"></i>
          <div>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <strong>${node.agent_hostname}</strong>
              <span class="text-muted">| ${node.hostname}</span>
              <span class="badge bg-light text-dark small">${node.type}</span>
              ${node.host_type ? `<span class="badge bg-secondary text-white small">${node.host_type}</span>` : ''}
            </div>
            <div class="text-muted small">IP: ${ip}</div>
            <div class="health-status ${healthClass}">${healthText}</div>
          
          </div>
          <div class="${statusClass} fw-semibold">${node.status}</div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <small class="text-muted me-2">Ost. aktualizacja: ${node.last_seen || 'n/a'}</small>
          <button class="btn btn-sm btn-secondary" onclick='showServerInfoModal(${JSON.stringify(node).replace(/"/g, '&quot;')})'>
            <i class="bi bi-info-circle"></i> Host
          </button>
          <button class="btn btn-sm btn-info" onclick='showContainersModal(${JSON.stringify(node.services).replace(/"/g, '&quot;')}, "${node.hostname}", "${ip}")'>
            <i class="bi bi-list"></i> Kontenery
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteNode('${node.hostname}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      <div class="metrics-row">
        ${cpu}
        ${ram}
        ${temp}
        ${disk}
      </div>
    `;
    list.appendChild(li);
  });
}

// Funkcja renderująca paski obciążenia
function renderProgressBar(label, value, colorClass) {
  if (value == null) return '';
  const safeValue = Math.min(Math.max(value, 0), 100);
  return `
    <div>
      <div class="metric-label">${label}: ${safeValue}%</div>
      <div class="progress">
        <div class="progress-bar bg-${colorClass}" role="progressbar" style="width: ${safeValue}%"></div>
      </div>
    </div>
  `;
}




// Modal — info o hoście z paskami obciążenia
function showServerInfoModal(node){
  const info = node.host_info || {};
  const cpu = info.cpu_percent ?? 0;
  const mem = info.memory_percent ?? 0;
  const disk = info.disk_percent ?? 0;
  const temp = info.cpu_temp ?? 0;

  const body = document.getElementById('serverInfoBody');
  body.innerHTML = `
    <p><strong>Hostname:</strong> ${node.hostname}</p>
    <p><strong>IP:</strong> ${info.ip || 'n/a'}</p>
    <p><strong>Typ:</strong> ${node.type}</p>
    <p><strong>Status:</strong> ${node.status}</p>
    <p><strong>Docker:</strong> ${info.docker_version || 'n/a'}</p>

    <div class="mt-3">
      <div class="progress-label"><i class="bi bi-cpu"></i> CPU (${cpu}%)</div>
      <div class="progress mb-2">
        <div class="progress-bar bg-danger" style="width: ${cpu}%"></div>
      </div>

      <div class="progress-label"><i class="bi bi-memory"></i> RAM (${mem}%)</div>
      <div class="progress mb-2">
        <div class="progress-bar bg-warning" style="width: ${mem}%"></div>
      </div>

      <div class="progress-label"><i class="bi bi-device-hdd"></i> Dysk (${disk}%)</div>
      <div class="progress mb-2">
        <div class="progress-bar bg-info" style="width: ${disk}%"></div>
      </div>

      <div class="progress-label"><i class="bi bi-thermometer-half"></i> Temperatura CPU (${temp}°C)</div>
      <div class="progress mb-3">
        <div class="progress-bar ${temp < 60 ? 'bg-success' : temp < 80 ? 'bg-warning' : 'bg-danger'}" style="width: ${Math.min(temp,100)}%"></div>
      </div>
    </div>

    <p><strong>Uptime:</strong> ${info.uptime ? (info.uptime / 3600).toFixed(1) + ' h' : 'n/a'}</p>
  `;
  new bootstrap.Modal(document.getElementById('serverInfoModal')).show();
}

// Modal — lista kontenerów
function showContainersModal(services, hostname, ip){
  const list = document.getElementById('containersList');
  list.innerHTML = '';

  if(services.length === 0){
    list.innerHTML = '<li class="list-group-item">Brak kontenerów</li>';
    return;
  }

  services.forEach(s => {
    const icon = getContainerIcon(s);
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';

    let linkBtn = '';
    if(s.port && ip){
      const match = s.port.match(/(\d+)->/);
      if(match){
        linkBtn = `<a href="http://${ip}:${match[1]}" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                     <i class="bi bi-box-arrow-up-right"></i>
                   </a>`;
      }
    }

    li.innerHTML = `
      <div><i class="bi ${icon} container-icon"></i> ${s.name} ${s.port ? `<span class="badge bg-info">${s.port}</span>` : ''}</div>
      <div class="d-flex align-items-center gap-1">
        <span class="badge ${s.status === 'running' ? 'bg-success' : 'bg-danger'}">${s.status}</span>
        ${linkBtn}
        <button class="btn btn-sm btn-warning" onclick="restartContainer('${hostname}','${s.name}')">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    `;
    list.appendChild(li);
  });

  new bootstrap.Modal(document.getElementById('containersModal')).show();
}

// Socket.IO eventy
socket.on('connect', () => socket.emit('get_fullstatus'));
socket.on('fullstatus', data => renderServers(data));
socket.on('update_nodes', () => socket.emit('get_fullstatus'));

// Restart kontenera
async function restartContainer(hostname, container_name){
  if(!confirm(`Czy na pewno chcesz zrestartować kontener ${container_name} na serwerze ${hostname}?`)) return;
  const res = await fetch('/api/restart_container', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({hostname, container_name})
  });
  const data = await res.json();
  alert(data.message || data.error);
}

// Usuwanie serwera
async function deleteNode(hostname){
  if(!confirm(`Czy na pewno chcesz usunąć serwer "${hostname}"?`)) return;
  const res = await fetch(`/api/delete_node`, {
    method: "POST",
    headers: {"Content-Type": "application/json", "X-API-KEY": "TwojSekretnyKlucz"},
    body: JSON.stringify({hostname})
  });
  const data = await res.json();
  if(res.ok){
    alert(data.message || `Serwer ${hostname} usunięty.`);
    socket.emit("get_fullstatus");
  } else {
    alert(`Błąd: ${data.error || "Nie udało się usunąć serwera."}`);
  }
}
</script>
</body>
</html>
